#!/usr/bin/with-contenv bash

# If the first run completed successfully, we are done
if [ -e /.firstUnicornTransRunComplete ]; then
  exit 0
fi

NODE_VERSION=16.13.0
NVM_DIR=/root/.nvm
PATH="/root/.nvm/versions/node/v${NODE_VERSION}/bin/:${PATH}"

echo [UNICORN TRANSCODER] Install Node10 and setup UnicornTranscoder
apt update && apt install git curl gpgv gnupg -y && curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash - \
    && chmod +x "$NVM_DIR/nvm.sh" \
	&& "$NVM_DIR/nvm.sh" && nvm install ${NODE_VERSION} \
	&& "$NVM_DIR/nvm.sh" && nvm use v${NODE_VERSION} \
	&& "$NVM_DIR/nvm.sh" && nvm alias default v${NODE_VERSION} \
	&& PATH="/root/.nvm/versions/node/v${NODE_VERSION}/bin/:${PATH}" \
	&& cd /opt \
	&& git clone https://github.com/UnicornTranscoder/UnicornTranscoder \
	&& cd /opt/UnicornTranscoder \
	&& git checkout ${GIT_SHA:-d74bda5253dee27b795aec48c5d9958d58d97da6} \
    && mkdir -p /root/.npm \
    && npm install \
    && npm run install \
    && apt-get autoremove -y \
	&& rm -rf /var/lib/apt/lists/*
    
# permissions
chown -R abc:abc \
	/opt/UnicornTranscoder /root/.npm

touch ./firstUnicornTransRunComplete